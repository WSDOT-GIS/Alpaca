define(["dojo/_base/declare","dojo/Deferred","dojo/Evented","esri/config","esri/graphic","esri/tasks/query","esri/tasks/QueryTask","esri/tasks/StatisticDefinition","./raceData","./languageData","./ageData","./utils","dojo/text!alpaca/aggregate_fields.txt"],function(n,t,i,r,u,f,e,o,s,h,c,l,a){"use strict";function rt(n){this.alias=n.alias||null;this.domain=n.domain||null;this.editable=n.editable||!1;this.length=n.length||null;this.name=n.name||null;this.type=n.type||null}function ut(n,t){return t&&t.name&&t.type?new rt(t):t}function w(n){var i,r,t;for(this.language=[],this.population=[],this.veteran=[],this.poverty=[],this.race=[],this.other=[],i=0,r=n.length;i<r;i+=1)t=n[i],t&&t.name&&!b.test(t.name)&&it.test(t.type)?tt.test(t.name)?this.language.push(t):d.test(t.name)?this.population.push(t):g.test(t.name)?this.veteran.push(t):nt.test(t.name)?this.poverty.push(t):k.test(t.name)?this.race.push(t):this.other.push(t):this.other.push(t)}function y(n){this.race=n.race?new s(n.race):new s(n);this.language=n.language?new h(n.language):new h(n);this.age=n.age?new c(n.age):new c(n)}function p(n,t,i,r){this.type=n||null;this.features=t||null;this.chartData=i instanceof y?i:new y(i);this.originalGeometry=r||null}var v,b,k,d,g,nt,tt,it;return b=/^ME/,tt=/^(?:Total(?:(?:English)|(?:Spanish)|(?:IndoEuropean)|(?:AsianPacificIsland)|(?:Other)))$/i,d=/^[MF]_([0-9]{1,2})?([a-z]+)?[0-9]+$/i,g=/^[MF](Age[0-9]{1,2})?([a-z]+)?[0-9]+(?:Non)?Vet$/i,nt=/^((?:Total_POV)|(?:Poverty_(?:Fed)|(?:State))|(?:PctPoverty)|(?:Income))$/i,k=/^(?:(?:(?:Not)?White)|(?:AfricanAmerican_Black)|(?:AmericanIndian_AlaskaNative)|(?:AsianAlone)|(?:NativeHawaiian_PacificIsl)|(?:SomeOtherRace)|(?:TwoOrMoreRaces))$/i,it=/(?:Integer)|(?:Double})/i,rt.prototype.toStatisticDefinition=function(n,t){var i;return i=new o,i.onStatisticField=this.name,i.statisticType=n||"sum",i.outStatisticFieldName=t||this.name,i},w.prototype.toStatisticDefinitions=function(){function t(n){return n.toStatisticDefinition()}var n=[];return n=n.concat(this.language.map(t)),n=n.concat(this.population.map(t)),n=n.concat(this.veteran.map(t)),n=n.concat(this.poverty.map(t)),n.concat(this.race.map(t))},w.prototype.getOutFields=function(){function t(n){return n.name}var n=[];return n=n.concat(this.language.map(t)),n=n.concat(this.population.map(t)),n=n.concat(this.veteran.map(t)),n=n.concat(this.poverty.map(t)),n.concat(this.race.map(t))},a=JSON.parse(a,ut),a=new w(a),v=n(i,{_statisticDefinitions:a.toStatisticDefinitions(),queryTasks:{blockGroup:null,tract:null,county:null},getQueryTaskForScale:function(n){var t;return t=l.getLevel(n),this.queryTasks[t]},getSelectionGraphics:function(n,i,e,o){function v(){var n=r.defaults.geometryService;return n||function(){var n=new TypeError("esri/config.defaults.geometryService not defined.");h.reject(n);s.emit("error",n)}(),n}function b(){var n,t;t=s.getQueryTaskForScale(i);n=new f;c="statewide";n.outStatistics=s._statisticDefinitions;t.execute(n,function(n){var i,t;i=n.features[0].attributes;t=new p(c,null,i);s.emit("totals-determined",t.chartData);s.emit("query-complete",t);h.resolve(t)},function(t){var i={type:c,query:n,error:t};s.emit("error",i);h.reject(i)})}function w(t){var r,o;o=s.getQueryTaskForScale(i);r=new f;r.geometry=t;r.outFields=a.getOutFields();r.returnGeometry=!0;o.execute(r,function(t){var i,w=[],a,b,r,f,o;for(i={},a=0,b=t.features.length;a<b;a+=1){r=t.features[a];r.geometry&&w.push(r.geometry);for(f in r.attributes)r.attributes.hasOwnProperty(f)&&(i[f]?i[f]+=r.attributes[f]:i[f]=r.attributes[f])}i=new y(i);e?(s.emit("totals-determined",i),h.progress({message:"totals determined",totals:i}),l=v(),l.union(w,function(n){r=new u(n,null,i);o=new p(c,[r],i,null);s.emit("query-complete",o);h.resolve(o)},function(n){n.totals=i;h.reject(n)})):(o=new p(c,t.features,i,n),h.resolve(o),s.emit("query-complete",o))},function(n){s.emit("error",n);h.reject(n)})}var s=this,h=new t,c,l;return c=n?e?"service area":"selection":"statewide",n?o?(l=v(),l.intersect([n],o,function(n){n&&n.length>=1&&w(n[0])},function(n){s.emit("intersect error",n);h.reject(n)})):w(n):b(),h.promise},constructor:function(n,t){if(!n)throw new TypeError("The map service URL was not provided.");t||(t={blockGroupLayerId:0,tractLayerId:1,countyLayerId:2});/\/$/.test(n)||(n+="/");this.queryTasks.blockGroup=new e(n+String(t.blockGroupLayerId));this.queryTasks.tract=new e(n+String(t.tractLayerId));this.queryTasks.county=new e(n+String(t.countyLayerId))}}),v.ChartData=y,v.ChartDataQueryResult=p,v});
//# sourceMappingURL=chartDataProvider.min.js.map